<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tres en Raya - SignalR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 400px;
        }

        /* ============================================
           PANTALLA DE ESPERA
           ============================================ */

        #esperaScreen h2 {
            color: #2c3e50;
            margin-top: 20px;
            font-size: 24px;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           PANTALLA DE JUEGO
           ============================================ */

        #gameScreen h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .ficha-texto {
            font-size: 20px;
            color: #34495e;
            margin-bottom: 10px;
        }

        .turno-texto {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .mi-turno {
            color: #27ae60;
        }

        .no-mi-turno {
            color: #95a5a6;
        }

        .tablero {
            display: inline-block;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 10px;
        }

        .fila {
            display: flex;
        }

        .casilla {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            background: white;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .casilla:hover:not(:disabled) {
            background: #e8f4f8;
            transform: scale(1.05);
        }

        .casilla:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .casilla.x {
            color: #e74c3c;
        }

        .casilla.o {
            color: #3498db;
        }

        /* ============================================
           PANTALLA DE RESULTADO
           ============================================ */

        #resultadoScreen h1 {
            font-size: 48px;
            margin-bottom: 40px;
        }

        .btn-nueva-partida {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-nueva-partida:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-nueva-partida:active {
            transform: translateY(0);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */

        @media (max-width: 600px) {
            .screen {
                min-width: 320px;
                padding: 20px;
            }

            .casilla {
                width: 80px;
                height: 80px;
                font-size: 36px;
            }

            #gameScreen h1 {
                font-size: 24px;
            }

            #resultadoScreen h1 {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE ESPERA -->
    <div id="esperaScreen" class="screen">
        <div class="loader"></div>
        <h2 id="esperaTexto">Esperando oponente...</h2>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div id="gameScreen" class="screen" style="display: none;">
        <h1>Tres en Raya</h1>
        <p id="fichaTexto" class="ficha-texto">Eres: -</p>
        <p id="turnoTexto" class="turno-texto">Esperando...</p>
        <div id="tablero" class="tablero"></div>
    </div>

    <!-- PANTALLA DE RESULTADO -->
    <div id="resultadoScreen" class="screen" style="display: none;">
        <h1 id="resultadoTexto">Resultado</h1>
        <button id="nuevaPartidaBtn" class="btn-nueva-partida">Nueva Partida</button>
    </div>

    <!-- SignalR CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

    <!-- JavaScript del juego -->
    <script>
        "use strict";

        // ============================================
        // CONFIGURACIÓN Y CONEXIÓN
        // ============================================

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/gamehub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // ============================================
        // ESTADO DEL JUEGO
        // ============================================

        let gameState = {
            tablero: [
                [null, null, null],
                [null, null, null],
                [null, null, null]
            ],
            miFicha: null,
            esMiTurno: false,
            estadoJuego: 'esperando', // 'esperando', 'jugando', 'terminado'
            resultado: null, // 'victoria', 'derrota', 'empate'
            turnoActual: null
        };

        // ============================================
        // ELEMENTOS DEL DOM
        // ============================================

        const esperaScreen = document.getElementById("esperaScreen");
        const gameScreen = document.getElementById("gameScreen");
        const resultadoScreen = document.getElementById("resultadoScreen");
        const tableroElement = document.getElementById("tablero");
        const fichaTexto = document.getElementById("fichaTexto");
        const turnoTexto = document.getElementById("turnoTexto");
        const resultadoTexto = document.getElementById("resultadoTexto");
        const nuevaPartidaBtn = document.getElementById("nuevaPartidaBtn");
        const esperaTexto = document.getElementById("esperaTexto");

        // ============================================
        // FUNCIONES DE RENDERIZADO
        // ============================================

        function mostrarPantalla(pantalla) {
            esperaScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            resultadoScreen.style.display = 'none';

            switch(pantalla) {
                case 'esperando':
                    esperaScreen.style.display = 'flex';
                    break;
                case 'jugando':
                    gameScreen.style.display = 'flex';
                    break;
                case 'terminado':
                    resultadoScreen.style.display = 'flex';
                    break;
            }
        }

        function renderizarTablero() {
            tableroElement.innerHTML = '';

            for (let i = 0; i < 3; i++) {
                const fila = document.createElement('div');
                fila.className = 'fila';

                for (let j = 0; j < 3; j++) {
                    const casilla = document.createElement('button');
                    casilla.className = 'casilla';
                    casilla.dataset.row = i;
                    casilla.dataset.col = j;

                    const valor = gameState.tablero[i][j];
                    if (valor) {
                        casilla.textContent = valor;
                        casilla.classList.add(valor === 'X' ? 'x' : 'o');
                        casilla.disabled = true;
                    } else {
                        casilla.disabled = !gameState.esMiTurno;
                    }

                    casilla.addEventListener('click', () => colocarFicha(i, j));
                    fila.appendChild(casilla);
                }

                tableroElement.appendChild(fila);
            }

            // Actualizar textos
            if (gameState.miFicha) {
                fichaTexto.textContent = `Eres: ${gameState.miFicha}`;
            }

            turnoTexto.textContent = gameState.esMiTurno ? '¡Tu turno!' : 'Esperando al oponente...';
            turnoTexto.className = 'turno-texto ' + (gameState.esMiTurno ? 'mi-turno' : 'no-mi-turno');
        }

        function convertirTablero(tableroServidor) {
            return tableroServidor.map(fila =>
                fila.map(celda => celda === ' ' ? null : celda)
            );
        }

        // ============================================
        // ACCIONES DEL JUEGO
        // ============================================

        function colocarFicha(x, y) {
            if (!gameState.esMiTurno) {
                console.log('No es tu turno');
                return;
            }

            if (gameState.tablero[x][y] !== null) {
                console.log('Casilla ocupada');
                return;
            }

            connection.invoke("ColocarFicha", x, y)
                .catch(err => {
                    console.error('Error al colocar ficha:', err);
                    alert('Error al realizar el movimiento');
                });
        }

        function nuevaPartida() {
            window.location.reload();
        }

        // ============================================
        // EVENTOS DE SIGNALR (DEL SERVIDOR)
        // ============================================

        connection.on("JugadorAsignado", function (ficha, esTuTurno) {
            console.log('Jugador asignado:', ficha, esTuTurno);
            gameState.miFicha = ficha;
            gameState.esMiTurno = esTuTurno;

            esperaTexto.textContent = `Esperando oponente... (Eres ${ficha})`;
        });

        connection.on("JuegoIniciado", function (tableroServidor, turnoActual) {
            console.log('Juego iniciado');
            gameState.tablero = convertirTablero(tableroServidor);
            gameState.turnoActual = turnoActual;
            gameState.estadoJuego = 'jugando';

            mostrarPantalla('jugando');
            renderizarTablero();
        });

        connection.on("MovimientoRealizado", function (tableroServidor) {
            console.log('Movimiento realizado');
            gameState.tablero = convertirTablero(tableroServidor);
            renderizarTablero();
        });

        connection.on("CambioTurno", function (turnoActual) {
            console.log('Cambio de turno:', turnoActual);
            gameState.turnoActual = turnoActual;
            renderizarTablero();
        });

        connection.on("JuegoTerminado", function (resultado, ganador) {
            console.log('Juego terminado:', resultado);
            gameState.resultado = resultado;
            gameState.estadoJuego = 'terminado';

            let textoResultado = '';
            let colorResultado = '';

            switch(resultado) {
                case 'victoria':
                    textoResultado = '¡Ganaste! 🎉';
                    colorResultado = '#27ae60';
                    break;
                case 'derrota':
                    textoResultado = 'Perdiste 😔';
                    colorResultado = '#e74c3c';
                    break;
                case 'empate':
                    textoResultado = '¡Empate! 🤝';
                    colorResultado = '#f39c12';
                    break;
            }

            resultadoTexto.textContent = textoResultado;
            resultadoTexto.style.color = colorResultado;

            mostrarPantalla('terminado');
        });

        connection.on("JugadorDesconectado", function () {
            console.log('Jugador desconectado');
            alert('El oponente se ha desconectado. La partida ha terminado.');
            window.location.reload();
        });

        connection.on("Error", function (mensaje) {
            console.error('Error del servidor:', mensaje);
            alert(`Error: ${mensaje}`);
        });

        // ============================================
        // INICIAR CONEXIÓN
        // ============================================

        connection.start()
            .then(function () {
                console.log('Conectado a SignalR');
                mostrarPantalla('esperando');
            })
            .catch(function (err) {
                console.error('Error de conexión:', err);
                alert('No se pudo conectar al servidor. Por favor, recarga la página.');
            });

        // Manejar reconexión automática
        connection.onreconnecting(error => {
            console.log('Reconectando...', error);
            alert('Conexión perdida. Intentando reconectar...');
        });

        connection.onreconnected(connectionId => {
            console.log('Reconectado:', connectionId);
            alert('Conexión restablecida. Recargando partida...');
            window.location.reload();
        });

        connection.onclose(error => {
            console.log('Conexión cerrada:', error);
            alert('Conexión cerrada. Por favor, recarga la página.');
        });

        // ============================================
        // EVENT LISTENERS
        // ============================================

        nuevaPartidaBtn.addEventListener("click", nuevaPartida);

        // Prevenir cierre accidental
        window.addEventListener('beforeunload', function (e) {
            if (gameState.estadoJuego === 'jugando') {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>